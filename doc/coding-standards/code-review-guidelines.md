# 代码审查（Code Review）规范

本文档定义了 Aether-Defense-System 项目的代码审查流程和标准，确保代码质量和系统可靠性。

## 为什么需要 Code Review？

### 项目特点分析

Aether-Defense-System 是一个**高并发微服务系统**，具有以下特点：

1. **高并发要求**：40,000 QPS 峰值流量，P99 < 100ms
2. **分布式架构**：多个微服务，服务间通过 gRPC 通信
3. **数据一致性**：使用 RocketMQ 事务消息，最终一致性
4. **性能敏感**：Redis Lua 脚本执行时间 < 0.5ms
5. **高可用性**：99.99% 可用性要求

### Code Review 的必要性

对于这样的系统，Code Review **是必需的**，原因如下：

#### 1. 性能问题影响巨大
- 一个性能问题可能导致系统崩溃
- 高并发场景下的 bug 影响面广
- 需要多人审查性能关键路径

#### 2. 分布式系统复杂性
- 服务间交互逻辑复杂
- 事务消息的正确性需要验证
- 幂等性实现需要仔细审查

#### 3. 安全风险
- 交易系统对安全要求高
- 数据泄露或注入攻击后果严重
- 需要安全专家审查

#### 4. 知识共享
- 团队成员了解不同服务
- 减少对特定人员的依赖
- 提升团队整体技术水平

## Code Review 流程

### 整体流程

```
开发者提交 PR
    ↓
自动化检查（CI/CD）
    ↓
代码审查（至少 1 人）
    ↓
审查反馈和修改
    ↓
再次审查（如需要）
    ↓
合并到主分支
```

### 详细步骤

#### 1. 提交 Pull Request

在提交 PR 前，确保：

- [ ] 所有测试通过
- [ ] Linter 检查通过
- [ ] Pre-commit hooks 通过
- [ ] 文档已更新
- [ ] 提交信息符合规范

#### 2. 自动化检查（CI/CD）

PR 创建后，CI/CD 自动运行：

- **测试**：运行所有单元测试和集成测试
- **Lint**：运行 golangci-lint 检查
- **覆盖率**：检查测试覆盖率是否满足要求
- **构建**：确保代码可以成功编译

**如果 CI 失败，PR 不能被合并。**

#### 3. 代码审查

##### 审查者要求

- **至少 1 人审查**：所有 PR 必须经过至少 1 人审查
- **核心功能 2 人审查**：涉及核心业务逻辑的 PR 需要 2 人审查
- **架构变更 3 人审查**：涉及架构变更的 PR 需要 3 人审查（包括架构师）

##### 审查时间要求

- **普通 PR**：24 小时内完成审查
- **紧急 PR**：4 小时内完成审查（需要明确标注）
- **大型 PR**：48 小时内完成审查

##### 审查重点

根据 PR 类型，关注不同的重点：

**功能开发 PR：**
- 功能实现是否正确
- 测试是否充分
- 性能是否满足要求
- 错误处理是否完善

**Bug 修复 PR：**
- Bug 是否真正修复
- 是否引入新的 bug
- 测试是否覆盖修复场景
- 是否有回归测试

**重构 PR：**
- 重构是否保持功能不变
- 代码质量是否提升
- 是否有足够的测试覆盖
- 性能是否受影响

**性能优化 PR：**
- 性能提升是否可验证
- 是否有性能测试数据
- 是否引入新的问题
- 代码可读性是否保持

## Code Review 检查清单

### 功能正确性

- [ ] **业务逻辑正确**：实现符合需求
- [ ] **边界条件处理**：处理了边界情况和异常情况
- [ ] **错误处理**：所有错误都被正确处理
- [ ] **数据验证**：输入数据被正确验证
- [ ] **状态管理**：状态转换正确（如订单状态机）

### 代码质量

- [ ] **代码风格**：符合项目代码规范
- [ ] **命名规范**：变量、函数、类型命名清晰
- [ ] **代码结构**：结构清晰，职责单一
- [ ] **代码复用**：避免重复代码
- [ ] **复杂度**：代码复杂度合理（圈复杂度 < 15）

### 测试

- [ ] **测试覆盖**：核心逻辑有测试覆盖（> 80%）
- [ ] **测试质量**：测试用例充分，包括正常和异常情况
- [ ] **测试命名**：测试函数命名清晰，描述测试内容
- [ ] **测试性能**：测试执行时间合理
- [ ] **集成测试**：服务间交互有集成测试

### 性能

- [ ] **性能要求**：满足性能指标（P99 < 100ms）
- [ ] **内存使用**：没有内存泄漏
- [ ] **并发安全**：正确处理并发场景
- [ ] **资源管理**：正确释放资源（连接、文件等）
- [ ] **热点路径优化**：关键路径已优化

### 安全性

- [ ] **输入验证**：所有用户输入都被验证
- [ ] **SQL 注入防护**：使用参数化查询
- [ ] **认证授权**：正确实现认证和授权
- [ ] **敏感信息**：敏感信息不在日志中输出
- [ ] **依赖安全**：依赖包没有已知安全漏洞

### 架构和设计

- [ ] **服务边界**：没有跨服务直接访问数据库
- [ ] **接口设计**：API 设计合理，符合 RESTful 规范
- [ ] **数据一致性**：分布式事务处理正确
- [ ] **幂等性**：操作是幂等的
- [ ] **可扩展性**：设计支持未来扩展

### 文档

- [ ] **API 文档**：API 有 `@doc` 注释
- [ ] **代码注释**：复杂逻辑有注释说明
- [ ] **架构文档**：架构变更已更新文档
- [ ] **README**：新功能已更新 README

### 项目特定检查

#### Go-Zero 框架

- [ ] **API 定义**：所有 HTTP API 定义在 `.api` 文件中
- [ ] **JWT 认证**：正确使用 JWT 中间件
- [ ] **错误处理**：使用 Go-Zero 错误码系统
- [ ] **服务调用**：服务间通过 gRPC 调用

#### 高并发场景

- [ ] **Redis Lua 脚本**：执行时间 < 0.5ms
- [ ] **Redis Key 命名**：符合命名规范
- [ ] **过期时间**：所有 Redis Key 都有过期时间
- [ ] **限流熔断**：正确配置限流和熔断
- [ ] **监控指标**：暴露 Prometheus metrics

#### 数据管理

- [ ] **ID 生成**：使用 Snowflake 算法
- [ ] **分库分表**：分片键选择正确
- [ ] **事务处理**：本地事务和分布式事务处理正确
- [ ] **幂等性**：实现去重逻辑

## Code Review 最佳实践

### 对审查者的建议

#### 1. 建设性反馈

- **具体明确**：指出具体的问题和位置
- **提供建议**：不仅指出问题，还提供改进建议
- **尊重开发者**：使用礼貌和尊重的语言
- **解释原因**：解释为什么需要修改

**好的反馈示例：**
```
这个函数可能在高并发场景下出现竞态条件。建议使用 sync.Mutex 保护共享状态，
或者考虑使用 channel 进行通信。参考：service/trade/rpc/trade.go:45
```

**不好的反馈示例：**
```
这里有问题。
```

#### 2. 关注重点

- **功能正确性**：代码是否实现了正确的功能
- **性能影响**：是否影响系统性能
- **安全性**：是否存在安全漏洞
- **可维护性**：代码是否易于理解和维护

#### 3. 及时响应

- 在 24 小时内完成审查
- 如果无法及时审查，告知开发者
- 对于紧急 PR，优先处理

#### 4. 学习机会

- 将 Code Review 视为学习机会
- 分享最佳实践和设计模式
- 讨论不同的实现方案

### 对开发者的建议

#### 1. 准备充分的 PR

- 确保所有检查通过
- 编写清晰的 PR 描述
- 添加必要的截图或示例
- 标记相关的 Issue

#### 2. 接受反馈

- 保持开放的心态
- 理解审查者的意图
- 及时响应和修改
- 如有疑问，主动沟通

#### 3. 小步提交

- 将大功能拆分为多个小 PR
- 每个 PR 专注于一个功能
- 便于审查和理解

#### 4. 自审查

- 提交前自己先审查一遍
- 运行所有测试和检查
- 检查文档是否更新

## PR 模板

创建 PR 时，使用以下模板：

```markdown
## 变更类型
- [ ] 新功能
- [ ] Bug 修复
- [ ] 重构
- [ ] 性能优化
- [ ] 文档更新
- [ ] 其他

## 变更描述
简要描述本次变更的内容和目的。

## 相关 Issue
关联的 Issue 编号（如有）

## 测试说明
- [ ] 已添加单元测试
- [ ] 已添加集成测试
- [ ] 已进行手动测试
- [ ] 测试覆盖率：XX%

## 性能影响
- [ ] 无性能影响
- [ ] 性能提升：描述提升情况
- [ ] 性能下降：描述下降情况和原因

## 检查清单
- [ ] 代码符合项目规范
- [ ] 所有测试通过
- [ ] Linter 检查通过
- [ ] 文档已更新
- [ ] 提交信息符合规范

## 截图/示例
（如适用，添加截图或示例）
```

## 审查工具和自动化

### GitHub/GitLab PR 功能

- **行内评论**：对特定代码行进行评论
- **建议修改**：直接建议代码修改
- **批准/拒绝**：明确批准或拒绝 PR
- **请求变更**：请求修改后重新审查

### 自动化工具

#### 1. 代码质量检查

- **golangci-lint**：静态代码分析
- **SonarQube**：代码质量分析（可选）
- **CodeQL**：安全漏洞检测（可选）

#### 2. 测试自动化

- **CI/CD 集成**：自动运行测试
- **覆盖率报告**：自动生成覆盖率报告
- **性能测试**：自动运行性能基准测试

#### 3. 依赖检查

- **Dependabot**：自动检查依赖更新和安全漏洞
- **Snyk**：安全漏洞扫描（可选）

## 审查指标和持续改进

### 关键指标

- **审查时间**：从 PR 创建到合并的平均时间
- **审查覆盖率**：所有 PR 都经过审查的比例
- **审查反馈率**：需要修改的 PR 比例
- **缺陷发现率**：通过审查发现的 bug 数量

### 持续改进

- **定期回顾**：每月回顾审查流程
- **收集团队反馈**：了解审查过程中的问题
- **优化流程**：根据反馈优化流程
- **培训**：定期进行 Code Review 培训

## 特殊情况处理

### 紧急修复

对于紧急 bug 修复：

1. **明确标注**：在 PR 标题和描述中标注 `[URGENT]`
2. **快速审查**：审查者优先处理
3. **简化流程**：可以简化部分检查，但核心检查不能跳过
4. **事后审查**：合并后进行全面审查

### 大型重构

对于大型重构：

1. **提前沟通**：重构前与团队沟通
2. **分步提交**：将重构拆分为多个小 PR
3. **充分测试**：确保重构后功能不变
4. **多人审查**：需要多人审查

### 架构变更

对于架构变更：

1. **设计文档**：先提交设计文档进行讨论
2. **架构审查**：需要架构师审查
3. **影响分析**：分析对现有系统的影响
4. **迁移计划**：制定详细的迁移计划

## 常见问题

### Q: 审查者太忙，无法及时审查怎么办？

A: 
1. 提前沟通，了解审查者时间安排
2. 将 PR 拆分为更小的 PR
3. 使用 `@mention` 提醒审查者
4. 如果紧急，联系其他审查者

### Q: 审查意见不一致怎么办？

A: 
1. 在 PR 中讨论，达成共识
2. 如果无法达成共识，请架构师或技术负责人决策
3. 记录决策过程和原因

### Q: 如何提高审查效率？

A: 
1. 保持 PR 小而专注
2. 编写清晰的 PR 描述
3. 确保自动化检查通过
4. 使用工具辅助审查

### Q: 审查时应该关注什么？

A: 
1. **功能正确性**：最重要
2. **性能影响**：对于高并发系统很重要
3. **安全性**：防止安全漏洞
4. **可维护性**：代码质量

## 参考资源

- [Google Code Review Guide](https://google.github.io/eng-practices/review/)
- [Atlassian Code Review Best Practices](https://www.atlassian.com/agile/software-development/code-reviews)
- [项目开发流程规范](./development-workflow.md)
- [项目代码规范](./README.md)

